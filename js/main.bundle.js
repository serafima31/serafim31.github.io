(()=>{"use strict";const e=e=>"Escape"===e.key||"Esc"===e.key,t="./db/log.json",r=(e,t,r)=>fetch(e).then((e=>{if(e.ok)return e.json();throw new Error(`${e.status}`)})).then((e=>{t(e)})).catch((e=>{r(e)})),o={0:["flat","palace","house","bungalow"],1:["palace"],2:["flat"],3:["house"],4:["bungalow"]},n={0:[],1:[1],2:[2],3:[3]},a={0:[],1:[2],2:[1],3:[0]},c=document.querySelector(".map__filters"),s=document.querySelector("#housing-type"),l=document.querySelector("#housing-price"),i=document.querySelector("#housing-rooms"),d=document.querySelector("#housing-guests"),u=document.querySelector("#housing-features");let p=0,m=0;for(;p<=150;)n[0].push(p++);for(;m<=150;)a[0].push(m++);const f=e=>{c.addEventListener("change",(()=>{e()}))},y=document.querySelector(".ad-form"),v=y.querySelectorAll("fieldset"),h=document.querySelector(".map__filters"),g=h.children,w=Array.from(g),S=document.querySelector("#address"),q=35.68331,k=139.7631,E=()=>{var e;(e=>{const t=document.createElement("div");t.style.zIndex=1e3,t.style.position="fixed",t.style.left=0,t.style.top=0,t.style.right=0,t.style.padding="10px 3px",t.style.fontSize="30px",t.style.textAlign="center",t.style.backgroundColor="red",t.textContent="Данные объявлений не загружены, попробуйте позже",document.body.append(t),setTimeout((()=>{t.remove()}),5e3)})(),e=w,h.classList.add("map__filters--disabled"),e.forEach((e=>{e.disabled=!0}))};((e,t,r,o)=>{e.classList.add("map__filters--disabled"),t.classList.add("ad-form--disabled"),r.forEach((e=>{e.disabled=!0})),o.forEach((e=>{e.disabled=!0}))})(h,y,v,w);const b=L.layerGroup(),x=e=>{e.slice().filter((e=>{return t=e,o[s.selectedIndex].includes(t.offer.type)&&(e=>{switch(l.selectedIndex){case 0:return e.offer.price>=0;case 1:return e.offer.price>=1e4&&e.offer.price<=5e4;case 2:return e.offer.price<1e4&&e.offer.price>=0;case 3:return e.offer.price>5e4}})(e)&&(e=>n[i.selectedIndex].includes(e.offer.rooms))(e)&&(e=>a[d.selectedIndex].includes(e.offer.guests))(e)&&(e=>Array.from(u.querySelectorAll("input:checked")).every((t=>e.offer.features.some((e=>e===t.value)))))(e);var t})).slice(0,10).forEach((e=>{const t=L.icon({iconUrl:"./img/pin.svg",iconSize:[42,42],iconAnchor:[21,42]});L.marker({lat:e.location.lat,lng:e.location.lng},{icon:t}).addTo(b).bindPopup((e=>{const t=document.querySelector("#card").content.querySelector(".popup").cloneNode(!0),r=t.querySelector(".popup__title"),o=t.querySelector(".popup__text--address"),n=t.querySelector(".popup__text--price"),a=t.querySelector(".popup__type"),c=t.querySelector(".popup__text--capacity"),s=t.querySelector(".popup__text--time"),l=t.querySelector(".popup__features"),i=e.offer.features,d=t.querySelector(".popup__description"),u=t.querySelector(".popup__photos"),p=t.querySelector(".popup__avatar");switch(r.textContent=e.offer.title,o.textContent=e.offer.address,n.textContent=e.offer.price+" ₽/ночь",e.offer.type){case"palace":a.textContent="Дворец";break;case"flat":a.textContent="Квартира";break;case"house":a.textContent="Дом";break;case"bungalow":a.textContent="Бунгало"}c.textContent=e.offer.rooms+" комнаты для "+e.offer.guests+" гостей",s.textContent="Заезд после "+e.offer.checkin+", выезд до "+e.offer.checkout;const m=document.createDocumentFragment();l.innerHTML="",0===i.length&&l.classList.add("hidden"),i.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),m.appendChild(t),l.appendChild(m)})),d.textContent=e.offer.description;const f=document.createDocumentFragment();u.innerHTML="";const y=e.offer.photos;for(let e=0;e<y.length;e++){const t=document.createElement("img");t.classList.add("popup__photo"),t.width=40,t.height=40,t.src=y[e],f.appendChild(t),u.appendChild(f)}return p.src=e.author.avatar,t})(e),{keepInView:!0}),b.addTo(C)}))},C=L.map("map-canvas").on("load",(()=>{((e,t,r,o)=>{e.classList.remove("map__filters--disabled"),t.classList.remove("ad-form--disabled"),r.forEach((e=>{e.disabled=!1})),o.forEach((e=>{e.disabled=!1}))})(h,y,v,w),S.readOnly=!0,S.value="35.68331, 139.7631",r(t,(e=>{x(e),f(_.debounce((()=>{b.clearLayers(),x(e)}),500))}),E)})).setView({lat:q,lng:k},13);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a>'}).addTo(C);const I=L.icon({iconUrl:"./img/main-pin.svg",iconSize:[52,52],iconAnchor:[26,52]}),V=L.marker({lat:q,lng:k},{draggable:!0,icon:I});V.addTo(C),V.on("moveend",(e=>{const t=e.target.getLatLng();let r=t.lat,o=t.lng;S.value=`${r.toFixed(5)}, ${o.toFixed(5)}`}));const F=["gif","jpg","jpeg","png","svg"],A=(e,t)=>{e.addEventListener("change",(()=>{const r=e.files[0],o=r.name.toLowerCase();if(F.some((e=>o.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{t.src=e.result})),e.readAsDataURL(r)}}))},T=(e,t)=>{e.src=t},D="img/muffin-grey.svg",j={0:[2],1:[1,2],2:[0,1,2],3:[3]},z=document.querySelector("main"),M=document.querySelector(".map__filters"),N=document.querySelector(".ad-form"),O=N.querySelector("#type"),U=N.querySelector("#price"),$=N.querySelector("#address"),H=N.querySelector("#timein"),P=N.querySelector("#timeout"),R=N.querySelector(".ad-form__element--time"),G=N.querySelector("#title"),W=N.querySelector("#room_number"),B=N.querySelector("#capacity"),J=N.querySelector(".ad-form__reset"),K=N.querySelector(".ad-form__field input[type=file]"),Q=N.querySelector(".ad-form-header__preview img"),X=N.querySelector(".ad-form__upload input[type=file]"),Y=N.querySelector(".ad-form__photo-preview"),Z=document.querySelector("#success ").content.querySelector(".success").cloneNode(!0),ee=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),te=ee.querySelector(".error__button");O.addEventListener("change",(e=>{switch(e.target.value){case"palace":U.value="",U.placeholder=1e4,U.min=1e4;break;case"flat":U.value="",U.placeholder=1e3,U.min=1e3;break;case"house":U.value="",U.placeholder=5e3,U.min=5e3;break;case"bungalow":U.value="",U.placeholder=0,U.min=0}})),R.addEventListener("change",(e=>{H.value=e.target.value,P.value=e.target.value})),G.addEventListener("input",(e=>{const t=e.target.value.valueLength;t<30?G.setCustomValidity("Еще "+(30-t)+" симв."):t>100?G.setCustomValidity("Удалите лишние "+(t-100)+" симв."):G.setCustomValidity(""),G.reportValidity()}));const re=e=>{j[W.selectedIndex].includes(B.selectedIndex)?e.target.setCustomValidity(""):e.target.setCustomValidity("Проверьте данные"),3===W.selectedIndex&&3===B.selectedIndex&&(W.setCustomValidity(""),B.setCustomValidity("")),e.target.reportValidity()};W.addEventListener("change",re),B.addEventListener("change",re);const oe=()=>{N.reset(),M.reset(),b.remove(),r(t,(e=>{x(e),f(_.debounce((()=>{b.clearLayers(),x(e)}),500))}),E),T(Q,D),T(Y,D),$.value="35.68331, 139.7631",V.setLatLng([q,k]),O.value="flat",U.value="",U.placeholder="1000",H.value="12:00",P.value="12:00",W.value="1",B.value="1"},ne=()=>{Z.remove(),window.removeEventListener("click",ne),window.removeEventListener("keydown",ae)},ae=t=>{e&&(t.preventDefault(),Z.remove(),window.removeEventListener("keydown",ae),window.removeEventListener("click",ne))},ce=()=>{oe(),z.appendChild(Z),window.addEventListener("click",ne),window.addEventListener("keydown",ae)},se=()=>{ee.remove(),window.removeEventListener("click",se),window.removeEventListener("keydown",le)},le=()=>{e&&(ee.remove(),window.removeEventListener("keydown",le),window.removeEventListener("click",se))},ie=()=>{ee.remove(),te.removeEventListener("click",ie)},de=()=>{z.appendChild(ee),window.addEventListener("click",se),window.addEventListener("keydown",le),te.addEventListener("click",ie)};J.addEventListener("click",(e=>{e.preventDefault(),oe()})),N.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData(e.target);var r,o;r=ce,o=de,fetch("https://22.javascript.pages.academy/keksobooking",{method:"POST",body:t}).then((e=>{e.ok?r():o()})).catch((()=>{o()}))})),A(K,Q),A(X,Y)})();
//# sourceMappingURL=main.bundle.js.map